#!/bin/bash

bold=$(tput bold)
normal=$(tput sgr0)

help() {
    cat <<EOF

${bold}NAME${normal}
       qsubctl - submit a job to a PBS system

${bold}SYNOPSIS${normal}
       qsubctl -h|--help|help

       qsubctl -s|status                                                                                     
       qsubctl -q|queue                                                                                      
       qsubctl <test-set-id> 

${bold}AUTHOR${normal}
       Jacek Kobus <jacek.kobus@umk.pl> 

${bold}COPYRIGHT${normal}
       SPDX-License-Identifier: GPL-2.0-or-later
       Copyright Â© 2023 Jacek Kobus

EOF
    exit
}

while getopts "qhs" option; do
    case $option in
	q ) qstat -q; exit;;
        h ) help; exit;;
        s ) qstat -n -u $USER; exit;;
	* ) echo "Error: unknown option" && help && exit
    esac
done

shift $((OPTIND-1))

[[ $1 == "" || $1 == status ]] && qstat -n -u $USER && exit 0

[[ $1 == queue ]] && qstat -q && exit 0


export TERM=xterm-256color

test=$1
job=$(echo $test |sed -e 's/\//-/')



cat <<EOF > /tmp/$job
#PBS -m be
#PBS -k oe
#PBS -l nodes=1:ppn=12
#PBS -l mem=20000mb
#PBS -l walltime=200:0:0
#PBS -N $job
##PBS -q tasq
##PBS -q medium
#PBS -q small

cd $HOME/github/2DHF/
source .x2dhfrc
cd $HOME/github/2DHF/tests
testctl run $test
EOF

qsub /tmp/$job

exit





